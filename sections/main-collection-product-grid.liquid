{%- assign product_limit = section.settings.product_per_page -%}
{%- assign show_second_img = section.settings.show_second_img -%}
{%- assign show_vendor = section.settings.show_vendor -%}
{%- assign enable_filtering = section.settings.enable_filtering -%}

<div class="{%- if enable_filtering -%}container-fluid {%- else %} container{%- endif -%}">
  <div class="row d-flex">
    {% if enable_filtering %}
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 bg-white">
        {% render 'collection-filter', collection: collection %}
      </div>
      <!-- Add mobile backdrop for filter -->
      <div class="collection-backdrop"></div>
    {% endif %}
    
    <div class="{% if enable_filtering %}col-md-9 col-xl-10{% else %}col-12{% endif %} py-3">
      <!-- Mobile filter toggle button -->
      {% if enable_filtering %}
        <div class="d-block d-md-none mb-3">
          <button class="btn btn-outline-secondary filter-toggle">
            <i class="bi bi-funnel me-2"></i> Show Filters
          </button>
        </div>
      {% endif %}
      
      <div class="collection-header">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
          <div class="product-counter mb-3 mb-md-0">
            <h1 class="h2 heading mb-1">{{ collection.title | escape }}</h1>
            {% if collection.description != blank %}
              <div class="collection-description text-muted">{{ collection.description }}</div>
            {% endif %}
          </div>
          <div class="sort-by--container">
            <div class="d-flex align-items-center">
              <label class="me-2 mb-0">Sort by:</label>
              <select id="sort-by" class="sort-by form-select">
                {% for option in collection.sort_options %}
                  <option
                    value="{{ option.value }}"
                    {% if option.value == collection.sort_by %}
                      selected
                    {% endif %}
                  >
                    {{ option.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="filter-heading mb-3 d-flex justify-content-between align-items-center">
        <p class="mb-0">Total products: <span class="badge bg-secondary">{{ collection.all_products_count }}</span></p>
      </div>
      
      <div class="collection-products my-3">
        {% paginate collection.products by product_limit -%}
          <div class="product-list">
            {% for product in collection.products %}
              {%- render 'product-card',
                product: product,
                column: 'col-12',
                show_second_img: show_second_img,
                show_vendor: show_vendor,
                horizontal_layout: true
              -%}
            {% endfor %}
          </div>

          <div class="pagination justify-content-center mt-5">
            {% render 'pagination', paginate: paginate %}
          </div>
        {% endpaginate %}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sort functionality
    Shopify.queryParams = {};
    if(location.search.length){
      for(let keyValue, i=0, queries = location.search.substr(1).split('&'); i < queries.length; i++){
        keyValue = queries[i].split('=');
        if(keyValue.length > 1){
          Shopify.queryParams[decodeURIComponent(keyValue[0])] = decodeURIComponent(keyValue[1]);
        }
      }
    }

    document.querySelector('.sort-by').addEventListener('change', function(e) {
      let value = e.currentTarget.value;
      Shopify.queryParams.sort_by = value;
      location.search = new URLSearchParams(Shopify.queryParams).toString();
    });
    
    // Mobile filter functionality
    const filterToggle = document.querySelector('.filter-toggle');
    const filterSidebar = document.querySelector('.col-auto');
    const backdrop = document.querySelector('.collection-backdrop');
    
    if (filterToggle && filterSidebar && backdrop) {
      filterToggle.addEventListener('click', function() {
        filterSidebar.classList.add('filter-active');
        backdrop.classList.add('active');
        document.body.classList.add('overflow-hidden');
      });
      
      backdrop.addEventListener('click', function() {
        filterSidebar.classList.remove('filter-active');
        backdrop.classList.remove('active');
        document.body.classList.remove('overflow-hidden');
      });
    }
  });
</script>

<style>
  /* Collection Styles */
  .product-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  
  .filter-heading .badge {
    font-size: 14px;
    font-weight: normal;
    padding: 6px 10px;
  }
  
  /* Mobile filter styles */
  .collection-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
  }
  
  .collection-backdrop.active {
    display: block;
  }
  
  /* Mobile filter toggle button */
  .filter-toggle {
    display: flex;
    align-items: center;
    padding: 8px 16px;
  }
  
  @media (max-width: 767px) {
    .col-auto {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 85%;
      max-width: 320px;
      z-index: 1100;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
    }
    
    .filter-active {
      transform: translateX(0);
    }
    
    .collection-header .product-counter {
      width: 100%;
    }
    
    .collection-header .sort-by--container {
      width: 100%;
    }
  }
  
  /* Collection Chooser Styles */
  .collection-chooser select {
    width: 100%;
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
  }

  .collection-chooser label {
    font-weight: bold;
  }

  /* Apply Button Styling */
  .filter-group-display__submit {
    margin-top: 10px;
  }

  .filter-group-display__submit .btn {
    width: 100%;
  }
</style>

{% schema %}
{
  "name": "Collection template",
  "settings": [
    
  ]
}
{% endschema %}
