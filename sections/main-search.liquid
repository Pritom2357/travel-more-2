{% layout 'theme' %}

<div class="search-results-container">
  <div class="container py-5">
    <div class="search-header mb-4">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="search-title">
            {% if search.terms != blank %}
              Search Results for "{{ search.terms }}"
            {% else %}
              All Tours
            {% endif %}
          </h1>
          <div class="search-meta">
            <span id="searchResultsCount" class="result-count">{{ search.results_count }} tours found</span>
            {% if search.filters != empty %}
              <span class="filters-applied">(Filters applied)</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-refinement">
            <form class="d-flex">
              <select class="form-select" id="sortOptions">
                <option value="relevance" {% if search.sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                <option value="price-ascending" {% if search.sort_by == 'price-ascending' %}selected{% endif %}>Price: Low to High</option>
                <option value="price-descending" {% if search.sort_by == 'price-descending' %}selected{% endif %}>Price: High to Low</option>
                <option value="best-selling" {% if search.sort_by == 'best-selling' %}selected{% endif %}>Best Selling</option>
              </select>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-3">
        <div class="filter-sidebar p-3 mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="filter-heading mb-0">Filters</h3>
            <button id="clearFilters" class="btn btn-sm btn-link">Clear all</button>
          </div>
          
          <div class="filter-group mb-4">
            <h4 class="filter-group-title">Duration</h4>
            <div class="filter-options">
              <div class="form-check">
                <input class="form-check-input duration-filter" type="checkbox" id="duration1" value="1-3">
                <label class="form-check-label" for="duration1">1-3 days</label>
              </div>
              <div class="form-check">
                <input class="form-check-input duration-filter" type="checkbox" id="duration2" value="4-7">
                <label class="form-check-label" for="duration2">4-7 days</label>
              </div>
              <div class="form-check">
                <input class="form-check-input duration-filter" type="checkbox" id="duration3" value="8-14">
                <label class="form-check-label" for="duration3">8-14 days</label>
              </div>
              <div class="form-check">
                <input class="form-check-input duration-filter" type="checkbox" id="duration4" value="15+">
                <label class="form-check-label" for="duration4">15+ days</label>
              </div>
            </div>
          </div>
          
          <div class="filter-group mb-4">
            <h4 class="filter-group-title">Price Range</h4>
            <div class="price-slider-container">
              <div class="price-range">
                <span id="priceMin">{{ cart.currency.symbol }}0</span>
                <span id="priceMax">{{ cart.currency.symbol }}10,000</span>
              </div>
              <input type="range" class="form-range" id="priceSlider" min="0" max="10000" step="100">
            </div>
          </div>
          
          <div class="filter-group">
            <h4 class="filter-group-title">Tour Type</h4>
            <div class="filter-options">
              {% for product_type in shop.product_types %}
                {% if product_type != '' %}
                  <div class="form-check">
                    <input class="form-check-input type-filter" type="checkbox" id="type-{{ product_type | handle }}" value="{{ product_type | handle }}">
                    <label class="form-check-label" for="type-{{ product_type | handle }}">{{ product_type }}</label>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-9">
        <div id="activeFilters" class="active-filters mb-3" style="display: none;">
          <div class="filter-tags d-flex flex-wrap gap-2"></div>
        </div>
        
        <div id="searchResultsGrid" class="search-results-grid">
          <div class="row g-4">
            {% if search.results != empty %}
              {% for product in search.results %}
                <div class="col-md-6 col-lg-4 tour-item">
                  <div class="tour-card">
                    <div class="tour-image">
                      {% if product.featured_image != blank %}
                        <img 
                          src="{{ product.featured_image | img_url: 'original', crop: 'center' }}" 
                          alt="{{ product.title }}"
                          width="400"
                          height="300"
                        >
                      {% else %}
                        <div class="placeholder-image">No Image</div>
                      {% endif %}
                    </div>
                    <div class="tour-details p-3">
                      <h3 class="tour-title">{{ product.title }}</h3>
                      <div class="tour-meta">
                        {% if product.metafields.tour.destination %}
                          <div class="tour-destination">
                            <i class="bi bi-geo-alt"></i> {{ product.metafields.tour.destination }}
                          </div>
                        {% endif %}
                        {% if product.metafields.tour.maximum_days_allowed %}
                          <div class="tour-duration">
                            <i class="bi bi-clock"></i> Up to {{ product.metafields.tour.maximum_days_allowed }} days
                          </div>
                        {% endif %}
                      </div>
                      <div class="tour-price">
                        From <span class="price">{{ product.price | money }}</span>
                      </div>
                      <a href="{{ product.url }}" class="btn btn-primary mt-2 w-100">View Tour</a>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="no-results text-center py-5">
                <div class="no-results-icon mb-3">
                  <i class="bi bi-search" style="font-size: 3rem;"></i>
                </div>
                <h2>No tours match your criteria</h2>
                <p class="mb-4">We couldn't find any tours that match your search. Try adjusting your filters or request a custom tour.</p>
                <div class="d-flex justify-content-center gap-3">
                  <button id="resetSearchBtn" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset Search
                  </button>
                  <a href="/pages/custom-tour-request" class="btn btn-primary">
                    <i class="bi bi-stars"></i> Request Custom Tour
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
        
        {% if paginate.pages > 1 %}
          <div class="pagination-container d-flex justify-content-center mt-5">
            <nav aria-label="Search results pages">
              <ul class="pagination">
                {% if paginate.previous %}
                  <li class="page-item">
                    <a class="page-link" href="{{ paginate.previous.url }}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% endif %}
                
                {% for part in paginate.parts %}
                  {% if part.is_link %}
                    <li class="page-item">
                      <a class="page-link" href="{{ part.url }}">{{ part.title }}</a>
                    </li>
                  {% else %}
                    <li class="page-item {% if part.title == paginate.current_page %}active{% endif %}">
                      <span class="page-link">{{ part.title }}</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if paginate.next %}
                  <li class="page-item">
                    <a class="page-link" href="{{ paginate.next.url }}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .search-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  .search-meta {
    color: #666;
    font-size: 1rem;
  }
  
  .result-count {
    font-weight: 500;
  }
  
  .filter-sidebar {
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  
  .filter-heading {
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .filter-group-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 10px;
  }
  
  .price-range {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.875rem;
  }
  
  .active-filters {
    background-color: #f0f8ff;
    padding: 10px;
    border-radius: 6px;
  }
  
  .filter-tag {
    background-color: #e9f2ff;
    border: 1px solid #cce0ff;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    margin-right: 8px;
    margin-bottom: 8px;
  }
  
  .filter-tag .remove-filter {
    margin-left: 5px;
    font-size: 1rem;
    cursor: pointer;
  }
  
  .tour-card {
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .tour-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  }
  
  .tour-image {
    height: 200px;
    overflow: hidden;
    position: relative;
  }
  
  .tour-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .tour-card:hover .tour-image img {
    transform: scale(1.1);
  }
  
  .placeholder-image {
    width: 100%;
    height: 100%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
  }
  
  .tour-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.3;
  }
  
  .tour-meta {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 10px;
  }
  
  .tour-destination, .tour-duration {
    margin-bottom: 4px;
  }
  
  .tour-price {
    font-size: 0.95rem;
    margin-bottom: 12px;
  }
  
  .tour-price .price {
    font-weight: 700;
    color: #449EED;
    font-size: 1.1rem;
  }
  
  .no-results {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 2rem;
  }
  
  .no-results-icon {
    color: #adb5bd;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const sortOptions = document.getElementById('sortOptions');
    const priceSlider = document.getElementById('priceSlider');
    const priceMin = document.getElementById('priceMin');
    const priceMax = document.getElementById('priceMax');
    const durationFilters = document.querySelectorAll('.duration-filter');
    const typeFilters = document.querySelectorAll('.type-filter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const activeFilters = document.getElementById('activeFilters');
    const filterTags = activeFilters.querySelector('.filter-tags');
    const resetSearchBtn = document.getElementById('resetSearchBtn');
    
    initializeFiltersFromUrl();
    
    sortOptions.addEventListener('change', function() {
      applyFilters();
    });
    
    priceSlider.addEventListener('input', function() {
      priceMax.textContent = {{ cart.currency.symbol }} + parseInt(this.value).toLocaleString();
    });
    
    priceSlider.addEventListener('change', function() {
      applyFilters();
    });
    
    durationFilters.forEach(filter => {
      filter.addEventListener('change', function() {
        applyFilters();
      });
    });
    
    typeFilters.forEach(filter => {
      filter.addEventListener('change', function() {
        applyFilters();
      });
    });
    
    clearFiltersBtn.addEventListener('click', function() {
      // Reset all filters
      durationFilters.forEach(filter => filter.checked = false);
      typeFilters.forEach(filter => filter.checked = false);
      priceSlider.value = priceSlider.max;
      priceMax.textContent = {{ cart.currency.symbol }} + parseInt(priceSlider.max).toLocaleString();
      
      applyFilters();
    });
    
    if (resetSearchBtn) {
      resetSearchBtn.addEventListener('click', function() {
        window.location.href = '/search';
      });
    }
    
    function applyFilters() {
      const searchParams = new URLSearchParams(window.location.search);
      console.log("searchParams: ", searchParams);
      
      const searchTerm = searchParams.get('q') || '';
      
      const newParams = new URLSearchParams();
      if (searchTerm) newParams.append('q', searchTerm);
      
      if (sortOptions.value !== 'relevance') {
        newParams.append('sort_by', sortOptions.value);
      }
      
      const selectedDurations = Array.from(durationFilters)
        .filter(filter => filter.checked)
        .map(filter => filter.value);
        
      if (selectedDurations.length > 0) {
        newParams.append('duration', selectedDurations.join(','));
      }
      
      const selectedTypes = Array.from(typeFilters)
        .filter(filter => filter.checked)
        .map(filter => filter.value);
        
      if (selectedTypes.length > 0) {
        newParams.append('type', selectedTypes.join(','));
      }
      
      if (parseInt(priceSlider.value) < parseInt(priceSlider.max)) {
        newParams.append('price_max', priceSlider.value);
      }
      
      const newUrl = window.location.pathname + '?' + newParams.toString();
      window.location.href = newUrl;
    }
    
    function initializeFiltersFromUrl() {
      const searchParams = new URLSearchParams(window.location.search);
      
      const sortBy = searchParams.get('sort_by');
      if (sortBy) {
        sortOptions.value = sortBy;
      }
      
      const priceMax = searchParams.get('price_max');
      if (priceMax) {
        priceSlider.value = priceMax;
        document.getElementById('priceMax').textContent = '$' + parseInt(priceMax).toLocaleString();
      }
      
      const durations = searchParams.get('duration');
      if (durations) {
        const durationArray = durations.split(',');
        durationFilters.forEach(filter => {
          filter.checked = durationArray.includes(filter.value);
        });
      }
      
      const types = searchParams.get('type');
      if (types) {
        const typeArray = types.split(',');
        typeFilters.forEach(filter => {
          filter.checked = typeArray.includes(filter.value);
        });
      }
      
      updateActiveFilters();
    }
    
    function updateActiveFilters() {
      const searchParams = new URLSearchParams(window.location.search);
      let hasActiveFilters = false;
      
      filterTags.innerHTML = '';
      
      const priceMax = searchParams.get('price_max');
      if (priceMax) {
        addFilterTag('Max $' + parseInt(priceMax).toLocaleString(), 'price_max');
        hasActiveFilters = true;
      }
      
      const durations = searchParams.get('duration');
      if (durations) {
        durations.split(',').forEach(duration => {
          addFilterTag('Duration: ' + duration + ' days', 'duration', duration);
        });
        hasActiveFilters = true;
      }
      
      const types = searchParams.get('type');
      if (types) {
        types.split(',').forEach(type => {
          addFilterTag('Type: ' + type.replace('-', ' '), 'type', type);
        });
        hasActiveFilters = true;
      }
      
      activeFilters.style.display = hasActiveFilters ? 'block' : 'none';
    }
    
    function addFilterTag(label, param, value = null) {
      const tag = document.createElement('span');
      tag.className = 'filter-tag';
      tag.innerHTML = label + '<span class="remove-filter">&times;</span>';
      
      tag.querySelector('.remove-filter').addEventListener('click', function() {
        removeFilter(param, value);
      });
      
      filterTags.appendChild(tag);
    }
    
    function removeFilter(param, value) {
      const searchParams = new URLSearchParams(window.location.search);
      
      if (value) {
        const values = searchParams.get(param).split(',');
        const newValues = values.filter(v => v !== value);
        
        if (newValues.length === 0) {
          searchParams.delete(param);
        } else {
          searchParams.set(param, newValues.join(','));
        }
      } else {
        searchParams.delete(param);
      }
      
      const newUrl = window.location.pathname + '?' + searchParams.toString();
      window.location.href = newUrl;
    }
  });
</script>